#!/usr/bin/env python3

import sys, os, uuid
import argparse
import pika, json
import logging.config
import config

modpath = os.path.abspath(os.path.join(os.path.dirname(__file__), os.pardir))
os.chdir(modpath)
sys.path.append(modpath)

# get commandline parameters
parser = argparse.ArgumentParser(description='Execute a Robomind Academy Python script.')
parser.add_argument('--pikaurl', type=str, default=config.PIKA_URL, help='rabbitmq url')
parser.add_argument('--logconf', type=str, default=config.LOG_CONFIG_FILE, help='port')
args = parser.parse_args()

# prepare pika
parameters = pika.URLParameters(args.pikaurl)
connection = pika.BlockingConnection(parameters)
channel = connection.channel()
channel.basic_qos(prefetch_count=1)


# prepare monitoring environment (including synchronous loghandler)
import monitor
monitor.mon = monitor.monitor_client.MonitorClient(connection, config.MONITOR_EXCHANGE)
monitor.mon.connect()

# prepare logging
logging.config.fileConfig(args.logconf)
logger = logging.getLogger(__name__)
logger.warning("starting logger")

# create the Bubble instance.
from bubblehub import Bubble
bubble_id = str(uuid.uuid4())
bubble = Bubble(bubble_id)
bubble.connect(channel)


def timer():
    import datetime
    bubble.timer(datetime.datetime.now())
    connection.add_timeout(1, timer)


connection.add_timeout(1, timer)

try:
    channel.start_consuming()
except KeyboardInterrupt:
    channel.stop_consuming()

connection.close()
